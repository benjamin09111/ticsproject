<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home</title>
    <link rel="stylesheet" href="./homestyle.css">
    <link rel="stylesheet" href="./navbarstyle.css">
    <script src="https://kit.fontawesome.com/06c04fea00.js" crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
</head>
<body id="bdy">
    <nav class="nav">
        <a href="/home">Home</a>
        <a href="/info">+Información</a>
        <button class="titi" id="logoutbutton" type="submit">Logout</button>
    </nav>
    <div id="a"></div>
    <main>
      <h1 style="text-align: center;" id="lol">DiabetesCare</h1>
        <article class="temperature-container">
          <label for="">Temperatura actual del dispositivo: </label><div id="temperaturetext">-</div>
    </article>
        <div style="display: flex; gap: 2rem; justify-content: center; align-items: center; flex-direction: column;"><h2 style="text-align: center;">Estado de los espacios</h2>
          <div><a href="/rellenar">Modificar información</a></div></div>
        <article class="buttons-container">
            <article id="container1" class="cont">
              <div class="l">Espacio 1</div>
              <div id="acabado1" style="color: red; font-size: 2rem;"></div>
              <div>Estado: <p class="b" id="b1">VACIO</p></div>
              <div>Dosis máxima: <p class="b" id="max1"></p></div>
              <div>Dosis actual: <p class="b" id="actuales1"></p></div>
              <div>Dosis a tomar: <p class="b" id="d1"></p></div>
              <div>
                <a href="/rellenar" class="btnmodificar" id="btnm1">Modificar</a>
                <button class="btnmodificar" id="restar1" onclick="restar1()" style="border: none;">Restar una dosis</button>
              </div>
            </article>
            <article id="container2"  class="cont">
              <div class="l">Espacio 2</div>
              <div id="acabado2" style="color: red; font-size: 2rem;"></div>
              <div>Estado: <p class="b" id="b2">VACIO</p></div>
              <div>Dosis máxima: <p class="b" id="max2"></p></div>
              <div>Dosis actual: <p class="b" id="actuales2"></p></div>
              <div>Dosis a tomar: <p class="b" id="d2"></p></div>
              <div><a href="/rellenar" class="btnmodificar" id="btnm2">Modificar</a>
              <button class="btnmodificar" id="restar2" onclick="restar2()" style="border: none;">Restar una dosis</button>
              </div>
            </article>
            <article id="container3" class="cont">
              <div class="l">Espacio 3</div>
              <div id="acabado3" style="color: red; font-size: 2rem;"></div>
              <div>Estado: <p class="b" id="b3">VACIO</p></div>
              <div>Dosis máxima: <p class="b" id="max3"></p></div>
              <div>Dosis actual: <p class="b" id="actuales3"></p></div>
              <div>Dosis a tomar: <p class="b" id="d3"></p></div>
              <div><a href="/rellenar" class="btnmodificar" id="btnm1">Modificar</a>
              <button class="btnmodificar" id="restar3" onclick="restar3()" style="border: none;">Restar una dosis</button>
              </div>
            </article>
            </article>

        <div class="modal-bg" id="modalBg"></div>

        <div class="emergente" style="display: none;" id="cuidadoModal">
          <span class="close" onclick="cerrarModal()">&times;</span>
          ¡Alerta! La temperatura es peligrosa, protega su dispositivo.
        </div>

        <div class="emergente" style="display: none;" id="avisollenar">
          <span class="close" onclick="cerrarModal()">&times;</span>
          Se ha acabado la dosis. Por favor, rellenar e informar a la aplicación.
          <a href="/rellenar">Modificar</a>
        </div>

        <div class="emergente" style="display: none;" id="espacio1aviso">
          <span class="close" onclick="cerrarModal1()">&times;</span>
          <div>Precaución: lleva mucho tiempo sin colocar la dosis en uso (Espacio 1).
            <b>RECUERDE</b> disminuir la dosis en caso de haberla tomado.</div>
          <a href="/rellenar">Modificar espacios</a>
        </div>

        <div class="emergente" style="display: none;" id="espacio2aviso">
          <span class="close" onclick="cerrarModal2()">&times;</span>
          <div>Precaución: lleva mucho tiempo sin colocar la dosis en uso (Espacio 2).
            <b>RECUERDE</b> disminuir la dosis en caso de haberla tomado.</div>
          <a href="/rellenar">Modificar espacios</a>
        </div>

        <div class="emergente" style="display: none;" id="espacio3aviso">
          <span class="close" onclick="cerrarModal3()">&times;</span>
          <div>Precaución: lleva mucho tiempo sin colocar la dosis en uso (Espacio 3).
            <b>RECUERDE</b> disminuir la dosis en caso de haberla tomado.</div>
          <a href="/rellenar">Modificar espacios</a>
        </div>

        <article class="historial-container">
            <h2>Historial</h2>
        <p style="text-align: center;">Se muestran los registros de temperatura relevantes, además del horario.</p>
      </article>
        <section class="list-container">
          <div id="temperaturesList" class="table">
            <!-- Aquí se añadirán las filas de temperatura -->
        </div>        

        <style>
          .table {
    display: flex;
    flex-direction: column;
    border: 1px solid #ddd; /* Añade un borde a la tabla */
}

.table-row {
    display: flex;
    justify-content: space-between;
    padding: 8px;
    border-bottom: 1px solid #ddd; /* Borde entre filas */
}

.table-cell {
    flex: 1; /* Ocupar espacio igual en ambas celdas */
    text-align: center;
}

        </style>

        </section>
    </main>
    
    <script src="./js/alerta.js"></script>
    <script src="./js/getTemperature.js"></script>
    <script src="./js/getTemperatures.js"></script>
    <script src="./js/salir.js"></script>

    <script>
    function cerrarModal(){
      const modalBg = document.getElementById("modalBg");
      const modal = document.getElementById("cuidadoModal");
      const espacio1 = document.getElementById("espacio1aviso");
      const espacio2 = document.getElementById("espacio2aviso");
      const espacio3 = document.getElementById("espacio3aviso");
      modalBg.style.display = "none";
      modal.style.display = "none";
      espacio1.style.display = "none";
      espacio2.style.display = "none";
      espacio3.style.display = "none";
    }

    </script>

<style>

.modal {
  display: none;
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  padding: 20px;
  background-color: #fff;
  z-index: 2; /* Asegura que esté por encima de la capa de fondo */
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); /* Sombra suave */
}

.close {
  position: absolute;
  top: 10px;
  right: 10px;
  font-size: 20px;
  cursor: pointer;
}

.btnmodificar{
  border: none;
  outline: none;
  padding: 1rem;
  border-radius: 15px;
  margin: 1rem 0rem;
  background: rgb(0, 198, 224);
  color: white;
  transition: background .2s ease;
}

.btnmodificar:hover{
  background: rgb(0, 117, 133);
}

</style>

<script>
function restar1(){
    const cookieString = document.cookie;
    const cookies = cookieString.split('; ');

    for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].split('=');
        const cookieName = cookie[0];
        const cookieValue = cookie[1];

        if (cookieName === 'token') {
            token = cookieValue;
            break;
        }
    }

    if(token == null || !token){
        window.location.href = "/";
    }else{
        fetch('https://ticsproject.onrender.com/restar1', {
        method: 'GET',
        headers: {
            'token': token,
            'Content-Type': 'application/json'
        }
    })
        .then(response => response.json())
        .then(data =>{

          if(data.success != "true"){
            window.location.href = '/fallo';
          }else{
            if(data.aviso == 1 && data.visible == 1){
              const aviso = document.getElementById("avisollenar");
              const fondo = document.getElementById("modalBg");
              aviso.style.display = "block";
              fondo.style.display = "block";
            }else{
              window.location.href = '/home';
            }
          }
        })
    }
}
function restar2(){
    const cookieString = document.cookie;
    const cookies = cookieString.split('; ');

    for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].split('=');
        const cookieName = cookie[0];
        const cookieValue = cookie[1];

        if (cookieName === 'token') {
            token = cookieValue;
            break;
        }
    }

    if(token == null || !token){
        window.location.href = "/";
    }else{
        fetch('https://ticsproject.onrender.com/restar2', {
        method: 'GET',
        headers: {
            'token': token,
            'Content-Type': 'application/json'
        }
    })
        .then(response => response.json())
        .then(data =>{
            
          if(data.success != "true"){
            window.location.href = '/fallo';
          }else{
            if(aviso == 1){
              const aviso = document.getElementById("avisollenar");
              const fondo = document.getElementById("modalBg");
              aviso.style.display = "block";
              fondo.style.display = "block";
            }else{
              window.location.href = '/home';
            }
          }
        })
    }
}
function restar3(){
    const cookieString = document.cookie;
    const cookies = cookieString.split('; ');

    for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].split('=');
        const cookieName = cookie[0];
        const cookieValue = cookie[1];

        if (cookieName === 'token') {
            token = cookieValue;
            break;
        }
    }

    if(token == null || !token){
        window.location.href = "/";
    }else{
        fetch('https://ticsproject.onrender.com/restar3', {
        method: 'GET',
        headers: {
            'token': token,
            'Content-Type': 'application/json'
        }
    })
        .then(response => response.json())
        .then(data =>{
            
          if(data.success != "true"){
            window.location.href = '/fallo';
          }else{
            if(aviso == 1){
              const aviso = document.getElementById("avisollenar");
              const fondo = document.getElementById("modalBg");
              aviso.style.display = "block";
              fondo.style.display = "block";
            }else{
              window.location.href = '/home';
            }
          }
        })
    }
}

function sendNotification(){
    //mandar notificación al usuario
    const cookieString = document.cookie;
    const cookies = cookieString.split('; ');

    for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].split('=');
        const cookieName = cookie[0];
        const cookieValue = cookie[1];

        if (cookieName === 'token') {
            token = cookieValue;
            break;
        }
    }

      if(token == null || !token){
        window.location.href = "/";
      }else{
        fetch('https://ticsproject.onrender.com/notification', {
        method: 'GET',
        headers: {
            'registrationToken': token,
            'Content-Type': 'application/json'
        }
    })
        .then(response => response.json())
        .then(data =>{
          if(data.success != "true"){
            window.location.href = '/fallo';
          }else{
            alert("Todo bien papito!");
          }
        })
      }

}

function alerta1(){
  const fondo = document.getElementById("modalBg");
  const av = document.getElementById("espacio1aviso");
  av.style.display = "block";
  fondo.style.display = "block";
}

function alerta2(){
  const fondo = document.getElementById("modalBg");
  const av = document.getElementById("espacio2aviso");
  av.style.display = "block";
  fondo.style.display = "block";
}

function alerta3(){
  const fondo = document.getElementById("modalBg");
  const av = document.getElementById("espacio3aviso");
  av.style.display = "block";
  fondo.style.display = "block";
}

function cerrarModal1(){
  const modalBg = document.getElementById("modalBg");
  const aviso = document.getElementById("espacio1aviso");

  // Ocultar tanto el fondo oscuro como el modal
  modalBg.style.display = "none";
  aviso.style.display = "none";
}

function cerrarModal2(){
  const modalBg = document.getElementById("modalBg");
  const aviso = document.getElementById("espacio2aviso");

  // Ocultar tanto el fondo oscuro como el modal
  modalBg.style.display = "none";
  aviso.style.display = "none";
}

function cerrarModal3(){
  const modalBg = document.getElementById("modalBg");
  const aviso = document.getElementById("espacio3aviso");

  // Ocultar tanto el fondo oscuro como el modal
  modalBg.style.display = "none";
  aviso.style.display = "none";
}

function pasedTime() {
    const works = document.getElementById("lol");
    const c1 = document.getElementById("container1");
    const c2 = document.getElementById("container2");
    const c3 = document.getElementById("container3");

    const dis1 = document.getElementById("b1");
    const dis2 = document.getElementById("b2");
    const dis3 = document.getElementById("b3");

    if (getComputedStyle(c1).display == "block" && dis1.textContent == "VACÍO") {
      alerta1();
    }

    if (getComputedStyle(c2).display == "block" && dis2.textContent == "VACÍO") {
      alerta2();
    }

    if (getComputedStyle(c3).display == "block" && dis3.textContent == "VACÍO") {
      alerta3();
    }
}

setInterval(pasedTime, 5000);


//-----------------

function mostrarModal() {
    const modalBg = document.getElementById("modalBg");
    const modal = document.getElementById("cuidadoModal");
    const cambiarcolor = document.getElementById("temperaturetext");


    cambiarcolor.style.color = "red";
    modalBg.style.display = "block";
    modal.style.display = "block";
}

const gettemperaturebutton = document.getElementById("getTemperature");

function actualizar(){
    const cookieString = document.cookie;
    const cookies = cookieString.split('; ');

    for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].split('=');
        const cookieName = cookie[0];
        const cookieValue = cookie[1];

        if (cookieName === 'token') {
            token = cookieValue;
            break;
        }
    }

    if(token == null || !token){
        window.location.href = "/";
    }else{
        fetch('https://ticsproject.onrender.com/gettemperature', {
        method: 'GET',
        headers: {
            'token': token,
            'Content-Type': 'application/json'
        }
    })
        .then(response => response.json())
        .then(data =>{
            const {temperature, buttons, max, dosis, actuales} = data;
            
            const text = document.getElementById("temperaturetext")
            text.textContent = temperature;

            const contenedor1 = document.getElementById("container1");
            const contenedor2 = document.getElementById("container2");
            const contenedor3 = document.getElementById("container3");

            const actuales1 = document.getElementById("actuales1");
            const actuales2 = document.getElementById("actuales2");
            const actuales3 = document.getElementById("actuales3");

            const max1 = document.getElementById("max1");
            const max2 = document.getElementById("max2");
            const max3 = document.getElementById("max3");

            const d1 = document.getElementById("d1");
            const d2 = document.getElementById("d2");
            const d3 = document.getElementById("d3");

            const bt1 = document.getElementById("b1");
            const bt2 = document.getElementById("b2");
            const bt3 = document.getElementById("b3");

            actuales1.textContent = actuales[0].toString();
            actuales2.textContent = actuales[1].toString();
            actuales3.textContent = actuales[2].toString();

            const a1 = document.getElementById("acabado1");
            const a2 = document.getElementById("acabado2");
            const a3 = document.getElementById("acabado3");

            const fondo = document.getElementById("modalBg");
            const aviso = document.getElementById("avisollenar");

            if(actuales[0] == 0 && max[0] > 0){
                a1.textContent = "¡ACABADO!";
                fondo.style.display = "block";
                aviso.style.display = "block";
            }
            if(actuales[1] == 0  && max[1] > 0){
                a2.textContent = "¡ACABADO!";
                fondo.style.display = "block";
                aviso.style.display = "block";
            }
            if(actuales[2] == 0  && max[2] > 0){
                a3.textContent = "¡ACABADO!";
                fondo.style.display = "block";
                aviso.style.display = "block";
            }

            max1.textContent = max[0].toString();
            max2.textContent = max[1].toString();
            max3.textContent = max[2].toString();

            if(max[0] <= 0){
                contenedor1.style.display = "none";
            }else{
                contenedor1.style.display = "block";
            }

            if(max[1] <= 0){
                contenedor2.style.display = "none";
            }else{
                contenedor2.style.display = "block";
            }

            if(max[2] <= 0){
                contenedor3.style.display = "none";
            }else{
                contenedor3.style.display = "block";
            }

            d1.textContent = dosis[0].toString();
            d2.textContent = dosis[1].toString();
            d3.textContent = dosis[2].toString();

            if(buttons[0] == 1){
                bt1.textContent = "VACÍO";
            }else{
                bt1.textContent = "OCUPADO";
            }

            if(buttons[1] == 1){
                bt2.textContent = "VACÍO";
            }else{
                bt2.textContent = "OCUPADO";
            }

            if(buttons[2] == 1){
                bt3.textContent = "VACIO";
            }else{
                bt3.textContent = "OCUPADO";
            }

            //modal aviso
            const parsedTemperature = parseFloat(temperature);
            if(parsedTemperature > 28 || parsedTemperature < 0){ //menor o igual a cero
                mostrarModal();
            }
        })
    }
}

function verificar(){
    const cookieString = document.cookie;
    const cookies = cookieString.split('; ');

    for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].split('=');
        const cookieName = cookie[0];
        const cookieValue = cookie[1];

        if (cookieName === 'token') {
            token = cookieValue;
            break;
        }
    }

    if(token == null || !token){
        window.location.href = "/";
    }else{
        fetch('https://ticsproject.onrender.com/getcont', {
        method: 'GET',
        headers: {
            'token': token,
            'Content-Type': 'application/json'
        }
    })
        .then(response => response.json())
        .then(data =>{
            const {cont} = data;

            if(cont==0){
                window.location.href = '/rellenar';
            }

        })
    }
}


document.addEventListener("DOMContentLoaded", function() {
   verificar();
   actualizar();
});

//realizar cada 5 seg
setInterval(actualizar, 7000);

</script>


<style>
  .modal-bg{
    display: none;
    height: 100vh;
    width: 100vw;
    background: rgb(0, 0, 0);
    z-index: 100;
    position: fixed;
    top: 0;
    left: 0;
    opacity: 0.5;
  }
  .emergente{
    display: none;
    background: white;
    color: black;
    padding: 2rem;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    position: fixed;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    z-index: 3000;
  }
</style>
</body>
</html>